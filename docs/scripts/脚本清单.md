# Datus Agent 脚本清单

> **文档版本**: v1.0
> **更新日期**: 2026-01-27
> **相关目录**: `scripts/`

---

## 脚本分类概览

| 分类 | 脚本数量 | 说明 |
|------|----------|------|
| [Schema 元数据管理](#一schema-元数据管理) | 8 | Schema 迁移、诊断、验证相关 |
| [模型下载](#二模型下载) | 2 | HuggingFace/ModelScope 模型下载 |
| [开发测试](#三开发测试) | 2 | 开发调试、测试相关 |
| [工具脚本](#四工具脚本) | 1 | 提示模板更新 |

---

## 一、Schema 元数据管理

> **相关文档**: [Schema 元数据管理脚本指南](../Schema%20元数据管理脚本指南.md)

### 1.1 migrate_v0_to_v1.py - Schema 迁移

**功能**: 将 LanceDB 中的 Schema 元数据从 v0 版本升级到 v1 增强版本。

**使用方式**:
```bash
python scripts/migrate_v0_to_v1.py --config=conf/agent.yml [选项]
```

**核心参数**:
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--config` | 配置文件路径 | 必填 |
| `--namespace` | 命名空间 | 自动选择 |
| `--extract-statistics` | 收集统计信息 | false |
| `--extract-relationships` | 提取关系 | true |
| `--import-schemas` | 迁移后导入 Schema | false |
| `--clear` | 导入前清除数据 | false |
| `--force` | 强制重新迁移 | false |
| `--llm-enum-extraction` | LLM 增强枚举提取 | false |

**完整迁移示例**:
```bash
python scripts/migrate_v0_to_v1.py \
  --config=conf/agent.yml \
  --namespace=test \
  --extract-statistics=true \
  --extract-relationships=true \
  --import-schemas \
  --llm-enum-extraction \
  --clear \
  --force
```

---

### 1.2 diagnose_schema_ddl.py - DDL 抽样诊断

**功能**: 抽样检查 LanceDB 中存储的 DDL 是否存在缺逗号/截断等问题。

**使用方式**:
```bash
python scripts/diagnose_schema_ddl.py --config=conf/agent.yml --namespace=<name>
```

**核心参数**:
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--config` | 配置文件路径 | conf/agent.yml |
| `--namespace` | 命名空间名称 | 自动选择 |
| `--catalog` | Catalog 过滤 | 空 |
| `--database` | Database 过滤 | 空 |
| `--limit` | 抽样表数量 | 5 |
| `--random` | 随机抽样 | false |
| `--compare-db` | 拉取数据库 DDL 对比 | false |

**示例**:
```bash
# 随机抽样 10 张表并对比数据库 DDL
python scripts/diagnose_schema_ddl.py \
  --config=conf/agent.yml \
  --namespace=test \
  --limit=10 \
  --random \
  --compare-db \
  --output=/tmp/ddl_sample.json
```

---

### 1.3 check_migration_report.py - 迁移质量报告

**功能**: 检查迁移覆盖率、字段填充率，生成质量报告。

**使用方式**:
```bash
python scripts/check_migration_report.py --config=conf/agent.yml [选项]
```

**参数**:
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--config` | 配置文件路径 | 必填 |
| `--namespace` | 命名空间 | - |
| `--top-tags` | 显示标签数量 | 10 |

**报告内容**:
- v1 记录比例
- `table_comment` 填充率
- `column_comments` 填充率
- `column_enums` 填充率
- `business_tags` 填充率
- `relationship_metadata` 覆盖率

---

### 1.4 rebuild_schema.sh - 重建 Schema

**功能**: 清空现有 Schema 数据后重新从数据库导入。

**使用方式**:
```bash
bash scripts/rebuild_schema.sh --namespace=<name> [选项]
```

**参数**:
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--namespace` | 命名空间名称 | 必填 |
| `--config` | 配置文件路径 | conf/agent.yml |
| `--clear` | 清除现有数据 | false |

**示例**:
```bash
# 标准重建
bash scripts/rebuild_schema.sh --namespace=my_database

# 清除数据后重建
bash scripts/rebuild_schema.sh --namespace=my_database --clear
```

---

### 1.5 backup_storage.sh - 备份存储

**功能**: 创建存储目录的带时间戳备份。

**使用方式**:
```bash
bash scripts/backup_storage.sh
```

**输出**:
```
检测到存储路径: /path/to/lancedb/storage
备份完成: /path/to/lancedb/storage.backup_v0_20260126_104800
```

---

### 1.6 live_bootstrap.py - 实时数据库引导

**功能**: 从实时数据库直接拉取 Schema 元数据，支持增量更新。

**使用方式**:
```bash
python scripts/live_bootstrap.py --config=conf/agent.yml [选项]
```

**核心参数**:
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--config` | 配置文件路径 | 必填 |
| `--namespace` | 命名空间 | - |
| `--database` | 数据库名称过滤 | 空 |
| `--dialect` | SQL 方言 | duckdb |
| `--extract-statistics` | 收集统计信息 | false |
| `--extract-relationships` | 提取关系 | true |
| `--incremental` | 增量更新模式 | false |

**支持方言**: `duckdb`, `sqlite`, `mysql`, `starrocks`, `snowflake`

---

### 1.7 check_storage_path.py - 检查存储路径

**功能**: 验证 `agent.yml` 配置的存储路径是否正确。

**使用方式**:
```bash
python scripts/check_storage_path.py
```

---

### 1.8 local_init.py - Schema 导入（模块）

**功能**: 直接从数据库导入 Schema 元数据到 LanceDB。

**使用方式**:
```bash
python -m datus.storage.schema_metadata.local_init --config=conf/agent.yml [选项]
```

**核心参数**:
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--config` | 配置文件路径 | 必填 |
| `--namespace` | 命名空间 | - |
| `--database` | 数据库名称 | 空 |
| `--llm-enum-extraction` | LLM 增强枚举提取 | false |

---

## 二、模型下载

### 2.1 download_models_cn.sh - 国内模型下载

**功能**: 下载 HuggingFace 模型，支持国内镜像和 ModelScope 回退。

**使用方式**:
```bash
bash scripts/download_models_cn.sh
```

**特点**:
- 自动检测并切换 HuggingFace 镜像
- 支持 ModelScope 作为备选源
- 下载到 `~/.datus/models/`

**下载内容**:
1. `qdrant/all-MiniLM-L6-v2-onnx` - 核心嵌入模型（必需）
2. `BAAI/bge-reranker-large` - 重排序模型（可选）

**手动下载示例**:
```bash
# 仅下载嵌入模型
bash scripts/download_models_cn.sh
# 出现提示时按 N 跳过重排序模型
```

---

### 2.2 download_models_docker.sh - Docker 模型下载

**功能**: Docker 构建专用模型下载，下载到 `docker/huggingface/` 目录。

**使用方式**:
```bash
bash scripts/download_models_docker.sh
```

**用途**: 在构建 Docker 镜像前预下载模型，避免网络超时。

**下载内容**:
1. `qdrant/all-MiniLM-L6-v2-onnx` → `docker/huggingface/fastembed/`
2. `BAAI/bge-reranker-large` → `docker/huggingface/reranker/`

**Docker 构建流程**:
```bash
# 1. 下载模型
bash scripts/download_models_docker.sh

# 2. 构建镜像
docker build -t datus-agent:latest .

# 3. 运行容器
docker run -p 8080:8080 \
  -v /path/to/agent.yml:/root/.datus/conf/agent.yml \
  datus-agent:latest
```

---

## 三、开发测试

### 3.1 test_sql_review.sh - SQL 审查测试

**功能**: 发送 SQL Review 请求并保存响应日志。

**使用方式**:
```bash
bash scripts/test_sql_review.sh
```

**输出**:
- `test_output/sql_review_YYYYMMDD_HHMMSS.log` - 完整日志
- `test_output/sql_review_YYYYMMDD_HHMMSS_messages.txt` - SSE 消息流

**配置修改**:
编辑脚本开头的配置变量:
```bash
API_URL="http://localhost:8080/workflows/chat_research"
NAMESPACE="test"
CATALOG_NAME="default_catalog"
DATABASE_NAME="test"
```

---

### 3.2 update_prompt_templates.py - 提示模板更新

**功能**: 从 JSON 文件批量更新提示模板。

**使用方式**:
```bash
python scripts/update_prompt_templates.py --config=conf/agent.yml --input=prompts.json
```

**参数**:
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--config` | 配置文件路径 | 必填 |
| `--input` | JSON 输入文件 | 必填 |
| `--dry-run` | 预览模式（不实际更新） | false |

**输入文件格式**:
```json
{
  "templates": [
    {
      "name": "gen_sql_user",
      "version": "1.1",
      "content": "# 新模板内容..."
    }
  ]
}
```

---

## 四、使用流程指南

### 4.1 完整 Schema 迁移流程

```bash
# 1. 备份现有数据
bash scripts/backup_storage.sh

# 2. 执行迁移（包含统计信息、关系、LLM枚举提取）
python scripts/migrate_v0_to_v1.py \
  --config=conf/agent.yml \
  --namespace=test \
  --extract-statistics=true \
  --extract-relationships=true \
  --import-schemas \
  --llm-enum-extraction \
  --clear \
  --force

# 3. 验证迁移质量
python scripts/check_migration_report.py \
  --config=conf/agent.yml \
  --namespace=test

# 4. 抽样诊断 DDL
python scripts/diagnose_schema_ddl.py \
  --config=conf/agent.yml \
  --namespace=test \
  --limit=10 \
  --random \
  --compare-db
```

### 4.2 Docker 部署流程

```bash
# 1. 下载模型
bash scripts/download_models_docker.sh

# 2. 构建镜像
docker build -t datus-agent:latest .

# 3. 运行服务
docker run -p 8080:8080 \
  -v /path/to/agent.yml:/root/.datus/conf/agent.yml \
  datus-agent:latest
```

### 4.3 国内环境模型下载

```bash
# 使用国内镜像下载
bash scripts/download_models_cn.sh

# 模型会保存到 ~/.datus/models/
```

---

## 五、故障排除

### 5.1 常见问题

| 问题 | 解决方案 |
|------|----------|
| LLM 回退失败 | 禁用 LLM 回退：`--llm-fallback=false` |
| 模型下载超时 | 使用国内镜像：`bash scripts/download_models_cn.sh` |
| 权限错误 | 确保数据库用户有访问系统表权限 |
| 存储路径冲突 | 检查 `agent.yml` 中的 namespace 配置 |

### 5.2 回滚操作

```bash
# 从备份恢复
bash scripts/backup_storage.sh  # 先创建新备份
rm -rf ~/.datus/data/datus_db
mv ~/.datus/data/datus_db.backup_* ~/.datus/data/datus_db
```

---

## 版本更新记录

### v1.0 (2026-01-27)
- 初始版本
- 整合所有 scripts 目录脚本说明
- 新增脚本分类和快速索引
- 添加使用流程指南

---

## 相关资源

- **项目主页**: [https://datus.ai](https://datus.ai)
- **文档**: [https://docs.datus.ai](https://docs.datus.ai)
- **GitHub**: [https://github.com/Datus-ai/Datus-agent](https://github.com/Datus-ai/Datus-agent)
