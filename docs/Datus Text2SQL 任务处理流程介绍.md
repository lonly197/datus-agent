# Datus Text2SQL ä»»åŠ¡å¤„ç†æµç¨‹ä»‹ç»

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.11
> **æ›´æ–°æ—¥æœŸ**: 2026-01-26
> **ç›¸å…³æ¨¡å—**: `datus/agent/workflow.yml`, `datus/agent/node/`

---

åŸºäºæœ€æ–°çš„ç³»ç»Ÿä¼˜åŒ–ä¸å®æˆ˜éªŒè¯ï¼ˆ2026-01-26ï¼‰ï¼ŒText2SQL ä»»åŠ¡å¤„ç†æµç¨‹å·²å‡çº§ä¸º**å…·å¤‡é«˜åº¦è‡ªæ„ˆèƒ½åŠ›çš„æ™ºèƒ½å·¥ä½œæµ**ã€‚ç³»ç»Ÿé‡‡ç”¨äº†è¯æ®é©±åŠ¨çš„ç”Ÿæˆæ¶æ„ï¼Œå¼•å…¥äº†**Preflight é¢„æ£€ç¼–æ’**ã€**æ„å›¾æ¾„æ¸…èŠ‚ç‚¹**ã€**ä¸“ç”¨ SQL éªŒè¯èŠ‚ç‚¹**ã€**æ•°ä»“å¼€å‘ç‰ˆ SQL æŠ¥å‘Š**ã€**å¤šå±‚çº§ Schema å‘ç°**ã€**Schema å……åˆ†æ€§éªŒè¯**ä¸**åŠ¨æ€åæ€çº é”™**æœºåˆ¶ï¼Œç¡®ä¿åœ¨ç”Ÿæˆ SQL ä¹‹å‰å…ˆå®Œæˆæ„å›¾åˆ†æã€Schema æ¢æŸ¥å’ŒéªŒè¯ï¼Œç„¶åè¿›è¡Œ SQL ç”Ÿæˆå’ŒéªŒè¯ï¼Œè‹¥ä¸åˆé€‚åˆ™é€šè¿‡ Reflect è¿›è¡Œåæ€ï¼Œç»§ç»­å°è¯•ï¼Œç›´åˆ°æ‰¾ä¸åˆ°æ»¡è¶³çš„è¡¨æ‰æŠ¥é”™ç»ˆæ­¢ã€‚

**v2.11 æ–°å¢ç‰¹æ€§**ï¼ˆ2026-01-26ï¼‰ï¼š

- âœ… **SQL å®¡æŸ¥ä»»åŠ¡è¯´æ˜**ï¼šæ–°å¢ç¬¬ 8 ç« ï¼Œè¡¥å…… SQL å®¡æŸ¥ä»»åŠ¡çš„å¤„ç†æµç¨‹è¯´æ˜
- âœ… **å·¥ä½œæµå¯¹æ¯”**ï¼šæ·»åŠ  Text2SQL ä¸ SQL å®¡æŸ¥å·¥ä½œæµçš„è¯¦ç»†å¯¹æ¯”è¡¨
- âœ… **äº¤å‰å¼•ç”¨**ï¼šæ·»åŠ åˆ° SQL å®¡æŸ¥æ–‡æ¡£çš„é“¾æ¥ï¼Œæ–¹ä¾¿ç”¨æˆ·æŸ¥é˜…å®Œæ•´å®ç°

**v2.10 æ–°å¢ç‰¹æ€§**ï¼ˆ2026-01-23ï¼‰ï¼š

- âœ… **Preflight Orchestrator**ï¼šé¢„æ£€å·¥å…·ç¼–æ’å™¨ï¼Œåè°ƒ4ä¸ªå¿…éœ€å·¥å…·æ‰§è¡Œ
- âœ… **ç¡¬å¤±è´¥æœºåˆ¶**ï¼šæ—  Schema æ—¶ç›´æ¥ç»ˆæ­¢ï¼Œä¸è¿›å…¥åæ€ç¯èŠ‚
- âœ… **å¤šæ•°æ®åº“æ”¯æŒ**ï¼šSchema å‘ç°æ”¯æŒæ‰«æå¤šä¸ªæ•°æ®åº“
- âœ… **LLM Schema åŒ¹é…**ï¼šå¤§è§„æ¨¡æ•°æ®é›†ä½¿ç”¨ LLM è¿›è¡Œè¡¨åŒ¹é…
- âœ… **æ¸è¿›å¼åŒ¹é…**ï¼šæ ¹æ®åæ€è½®æ¬¡åŠ¨æ€è°ƒæ•´åŒ¹é…ç­–ç•¥

**v2.8 ç‰¹æ€§å›é¡¾**ï¼ˆ2026-01-16ï¼‰ï¼š

- âœ… **æ„å›¾æ¾„æ¸…èŠ‚ç‚¹** (`IntentClarificationNode`)ï¼šä¿®å¤é”™åˆ«å­—ã€æ¾„æ¸…æ¨¡ç³Šè¡¨è¿°ã€æå–ä¸šåŠ¡å®ä½“
- âœ… **ä¸“ç”¨ SQL éªŒè¯èŠ‚ç‚¹** (`SQLValidateNode`)ï¼šé›†ä¸­å¼ SQL è¯­æ³•å’Œè¯­ä¹‰éªŒè¯
- âœ… **å·¥ä½œæµç»ˆæ­¢æœºåˆ¶**ï¼šæ”¯æŒä¸»åŠ¨ç»ˆæ­¢å·¥ä½œæµï¼Œé¿å…åå°ç»§ç»­è¿è¡Œ
- âœ… **ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤**ï¼šè¯­ä¹‰æœç´¢å¢åŠ  0.5 ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œè¿‡æ»¤å¼±åŒ¹é…ç»“æœ
- âœ… **Context Search ä¼˜åŒ–**ï¼šè§¦å‘é˜ˆå€¼ä» 3 æå‡åˆ° 10ï¼Œæ›´é¢‘ç¹è§¦å‘æ·±åº¦å…ƒæ•°æ®æ‰«æ
- âœ… **æ‰¹é‡ Schema æŸ¥è¯¢**ï¼šæ–°å¢ `get_table_schemas()` æ–¹æ³•æ”¯æŒæ‰¹é‡è¡¨ç»“æ„æŸ¥è¯¢
- âœ… **å…ƒæ•°æ®è‡ªåŠ¨ä¿®å¤**ï¼š`update_table_schema()` æ–¹æ³•æ”¯æŒ DDL å›å¡«å’Œå…ƒæ•°æ®ä¿®å¤
- âœ… **å¤šå±‚ç¼“å­˜æœºåˆ¶**ï¼šL1 ç¼“å­˜ï¼ˆåµŒå…¥æ¨¡å‹ï¼‰ã€LLM ç¼“å­˜ï¼ˆ1å°æ—¶ TTLï¼‰ã€CLI ç¼“å­˜ï¼ˆLRU 128ï¼‰

## 1. æ¥å£æ¦‚è§ˆ

**æ¥å£è·¯å¾„**: `POST /workflows/chat_research`
**åŠŸèƒ½**: æ‰§è¡ŒèŠå¤©ç ”ç©¶å·¥ä½œæµï¼Œæ”¯æŒ Text2SQLã€SQLå®¡æŸ¥ã€æ•°æ®åˆ†æç­‰å¤šç§åœºæ™¯
**å“åº”æ ¼å¼**: Server-Sent Events (SSE) æµå¼å“åº”

## 2. æ ¸å¿ƒå·¥ä½œæµæ¶æ„

å½“å‰çš„ Text2SQL ä»»åŠ¡é»˜è®¤é‡‡ç”¨ `text2sql` å·¥ä½œæµé…ç½®ï¼Œè¿™æ˜¯ä¸€ä¸ªåŒ…å«**æ„å›¾æ¾„æ¸…**ã€**SQL éªŒè¯**ä¸**åæ€ï¼ˆReflectionï¼‰**ç¯èŠ‚çš„é—­ç¯æµç¨‹ã€‚

**å·¥ä½œæµå®šä¹‰** (`datus/agent/workflow.yml`):

```yaml
text2sql:
  - intent_analysis       # æ„å›¾åˆ†æï¼ˆä»»åŠ¡ç±»å‹è¯†åˆ«ï¼‰
  - intent_clarification  # æ„å›¾æ¾„æ¸…ï¼ˆé”™åˆ«å­—ã€æ­§ä¹‰ã€å®ä½“æå–ï¼‰â­ NEW
  - schema_discovery      # Schema å‘ç°ï¼ˆä¸‰é˜¶æ®µæ··åˆå¬å›ï¼‰
  - schema_validation     # Schema å……åˆ†æ€§éªŒè¯
  - generate_sql          # SQL ç”Ÿæˆ
  - sql_validate          # SQL è¯­æ³•å’Œè¯­ä¹‰éªŒè¯ â­ NEW
  - execute_sql           # SQL æ‰§è¡Œ
  - result_validation     # ç»“æœè´¨é‡éªŒè¯
  - reflect               # åæ€ä¸çº é”™ï¼ˆæ ¸å¿ƒè‡ªæ„ˆç»„ä»¶ï¼‰
  - output                # ç»“æœè¾“å‡º
```

**è®¾è®¡ç†å¿µ**:

- **ä¸¤é˜¶æ®µæ„å›¾å¤„ç†**ï¼šä»»åŠ¡ç±»å‹è¯†åˆ« â†’ ä¸šåŠ¡æ„å›¾æ¾„æ¸…
- **ä¸‰é˜¶æ®µ Schema å‘ç°**ï¼šè¯­ä¹‰/å…³é”®è¯/LLM â†’ Context æ·±åº¦æœç´¢ â†’ Fallback å…¨è¡¨æ‰«æ
- **Preflight é¢„æ£€ç¼–æ’**ï¼šç”Ÿæˆå‰é¢„æ‰§è¡Œ4ä¸ªå¿…éœ€å·¥å…·ï¼Œç¡®ä¿è¯æ®å……åˆ†
- **åŒé‡éªŒè¯æœºåˆ¶**ï¼šSchema å……åˆ†æ€§éªŒè¯ â†’ SQL è¯­æ³•è¯­ä¹‰éªŒè¯
- **æ™ºèƒ½åæ€æœºåˆ¶**ï¼šè½¯å¤±è´¥çŠ¶æ€ + åŠ¨æ€ç­–ç•¥æ³¨å…¥ï¼Œæ”¯æŒè‡ªæ„ˆæ¢å¤

## 3. å…³é”®èŠ‚ç‚¹ä¸æ‰§è¡Œé€»è¾‘

### 3.1 Intent Analysis (æ„å›¾åˆ†æ)

**ç›®æ ‡**ï¼šè¯†åˆ«ä»»åŠ¡ç±»å‹ï¼ˆtext2sql vs sql_review vs data_analysisï¼‰ã€‚

**æ‰§è¡Œé€»è¾‘**:

- å¿«é€Ÿå¯å‘å¼æ£€æµ‹ï¼šåŸºäº SQL å…³é”®è¯å’Œæ¨¡å¼è¯†åˆ«ä»»åŠ¡ç±»å‹
- å¯é€‰ LLM åˆ†ç±»ï¼šå½“å¯å‘å¼ç½®ä¿¡åº¦ < 0.7 æ—¶ï¼Œä½¿ç”¨ LLM åˆ†ç±»
- è·³è¿‡é€»è¾‘ï¼šå½“ `execution_mode` å·²æŒ‡å®šæ—¶è·³è¿‡æ­¤èŠ‚ç‚¹

### 3.2 Intent Clarification (æ„å›¾æ¾„æ¸…) â­ NEW v2.8

**ç›®æ ‡**ï¼šç†æ¸…ç”¨æˆ·çš„çœŸå®åˆ†ææ„å›¾ï¼Œå¤„ç†è¡¨è¿°ä¸æ¸…ã€é”™åˆ«å­—ç­‰é—®é¢˜ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:

- **é”™åˆ«å­—ä¿®å¤**ï¼š`"åå±±"` â†’ `"åå—"`
- **æ­§ä¹‰æ¾„æ¸…**ï¼š`"æœ€è¿‘çš„é”€å”®"` â†’ `"æœ€è¿‘30å¤©çš„é”€å”®æ•°æ®"`
- **å®ä½“æå–**ï¼š`business_terms`ã€`time_range`ã€`dimensions`ã€`metrics`
- **æŸ¥è¯¢è§„èŒƒåŒ–**ï¼šä¸º Schema Discovery æä¾›æ›´æ¸…æ™°çš„æœç´¢å…³é”®è¯

**å®ç°æ–¹å¼**:

- åŸºäº LLM çš„è¯­ä¹‰ç†è§£å’Œä¿®æ­£
- è¾“å‡ºç»“æ„åŒ– JSON ç»“æœå­˜å‚¨åœ¨ `workflow.metadata["clarified_task"]`
- 1 å°æ—¶ TTL ç¼“å­˜ï¼Œé¿å…é‡å¤è°ƒç”¨

**ç¤ºä¾‹**:

```python
# åŸå§‹ä»»åŠ¡
task = "å¸®æˆ‘æŸ¥ä¸‹åå±±åœ°åŒºçš„é”€å”®æ•°æ®"

# æ¾„æ¸…å
clarified_task = "å¸®æˆ‘æŸ¥è¯¢åå—åœ°åŒºï¼ˆå¹¿ä¸œï¼‰çš„é”€å”®æ•°æ®"

# æå–çš„å®ä½“
business_terms = ["åå—", "å¹¿ä¸œ"]
time_range = "æœ€è¿‘30å¤©"ï¼ˆå¦‚æœ‰ï¼‰
```

### 3.3 Schema Discovery (æ™ºèƒ½æ¨¡å¼å‘ç°)

**ç›®æ ‡**ï¼šè§£å†³"é›¶å¬å›"ä¸"å¹»è§‰"é—®é¢˜ï¼Œç¡®ä¿ä¸‹æ¸¸èŠ‚ç‚¹æ‹¥æœ‰çœŸå®çš„ä¸Šä¸‹æ–‡ã€‚

**ä¸‰é˜¶æ®µæ··åˆæœç´¢ç­–ç•¥**:

#### **é˜¶æ®µ 1: å¿«é€Ÿæ··åˆå¬å›**

- **è¯­ä¹‰æ£€ç´¢**ï¼š`SchemaWithValueRAG.search_similar()`ï¼Œ`top_n=20`ï¼Œç›¸ä¼¼åº¦é˜ˆå€¼ 0.5
- **æ··åˆæ£€ç´¢**ï¼šå‘é‡ + FTS èåˆæ’åºï¼Œå¯é€‰ LanceDB rerankï¼ˆhybrid query + rerankï¼‰ã€‚å½“ `hybrid_rerank_enabled=true` ä¸”å€™é€‰è¡¨æ•°é‡ â‰¥ `hybrid_rerank_min_tables`ã€æ¨¡å‹æ–‡ä»¶å­˜åœ¨ä¸”èµ„æºå……è¶³æ—¶è§¦å‘ï¼›è‹¥æ¨¡å‹ç¼ºå¤±/èµ„æºä¸è¶³æˆ– reranker åˆå§‹åŒ–å¤±è´¥åˆ™è·³è¿‡å¹¶å›é€€åˆ°è¯­ä¹‰/FTSèåˆæ’åºã€‚
- **å…³é”®è¯åŒ¹é…**ï¼šåŸºäºç¡¬ç¼–ç çš„ä¸šåŠ¡æœ¯è¯­æ˜ å°„
- **LLM æ¨æ–­**ï¼šä¸­æ–‡æŸ¥è¯¢æˆ–æ¨¡ç³Šæœ¯è¯­æ—¶è§¦å‘ï¼Œ1 å°æ—¶ TTL ç¼“å­˜

**æ··åˆæ£€ç´¢é…ç½®ç¤ºä¾‹**ï¼ˆ`agent.yml`ï¼‰ï¼š
```yaml
schema_discovery:
  hybrid_search_enabled: true
  hybrid_use_fts: true
  hybrid_vector_weight: 0.6
  hybrid_fts_weight: 0.3
  hybrid_row_count_weight: 0.2
  hybrid_tag_bonus: 0.1
  hybrid_comment_bonus: 0.05
  hybrid_rerank_enabled: false
  hybrid_rerank_model: "./models/bge-reranker-large"
  hybrid_rerank_column: "definition"
  hybrid_rerank_min_cpu_count: 4
  hybrid_rerank_min_memory_gb: 8.0
```

**æƒé‡æ ¡éªŒè§„åˆ™**:
- `hybrid_*_weight`ã€`hybrid_tag_bonus`ã€`hybrid_comment_bonus` å¿…é¡»åœ¨ `[0,1]`ï¼Œå¦åˆ™å›é€€é»˜è®¤å€¼å¹¶è®°å½• warning
- `hybrid_rerank_min_tables` å¿…é¡» `>= 0`ï¼Œå¦åˆ™å›é€€ä¸º 20
- `hybrid_rerank_top_n` å¿…é¡» `>= 1`ï¼Œå¦åˆ™å›é€€ä¸º 50
- `hybrid_rerank_model` / `hybrid_rerank_column` ç”¨äºé…ç½® reranker æ¨¡å‹ä¸è¾“å…¥åˆ—ï¼ˆ`hybrid_rerank_model` éœ€ä¸ºæœ¬åœ°æ¨¡å‹è·¯å¾„ï¼‰
- `hybrid_rerank_min_cpu_count` / `hybrid_rerank_min_memory_gb` ç”¨äºèµ„æºé—¨æ§›æ ¡éªŒï¼Œä¸æ»¡è¶³åˆ™ç¦ç”¨ rerank

**ç»Ÿè®¡å­—æ®µè¯´æ˜**ï¼ˆå†™å…¥ `workflow.metadata["schema_discovery_stats"]`ï¼‰:
- `semantic_vector_hits`ï¼šå‘é‡å¬å›æ•°é‡
- `semantic_fts_hits`ï¼šFTS å¬å›æ•°é‡
- `semantic_rerank_hits`ï¼šrerank å‚ä¸è¡¨æ•°é‡
- `hybrid_*`ï¼šæ··åˆæ£€ç´¢å¼€å…³ä¸æƒé‡é…ç½®å¿«ç…§ï¼ˆç”¨äºæ’æŸ¥ï¼‰

**é‡å¤§åœºæ™¯æ¨èç»„åˆï¼ˆText2SQLï¼‰**:

1) SQL ç”Ÿæˆï¼ˆé«˜å¹¶å‘ + è¦†ç›–ä¼˜å…ˆï¼‰
```yaml
schema_discovery:
  hybrid_search_enabled: true
  hybrid_use_fts: true
  hybrid_vector_weight: 0.5
  hybrid_fts_weight: 0.4
  hybrid_row_count_weight: 0.2
  hybrid_tag_bonus: 0.1
  hybrid_comment_bonus: 0.05
  hybrid_rerank_enabled: false
```

2) SQL å®¡æŸ¥ï¼ˆé«˜ç²¾åº¦ + è¯¯æŠ¥æ§åˆ¶ï¼‰
```yaml
schema_discovery:
  hybrid_search_enabled: true
  hybrid_use_fts: true
  hybrid_vector_weight: 0.6
  hybrid_fts_weight: 0.3
  hybrid_row_count_weight: 0.2
  hybrid_tag_bonus: 0.1
  hybrid_comment_bonus: 0.05
  hybrid_rerank_enabled: true
  hybrid_rerank_weight: 0.2
  hybrid_rerank_min_tables: 10
  hybrid_rerank_top_n: 50
  hybrid_rerank_model: "./models/bge-reranker-large"
  hybrid_rerank_column: "definition"
  hybrid_rerank_min_cpu_count: 4
  hybrid_rerank_min_memory_gb: 8.0
```

#### **é˜¶æ®µ 2: æ·±åº¦å…ƒæ•°æ®æ‰«æ** (Context Search)

**è§¦å‘æ¡ä»¶**ï¼šé˜¶æ®µ 1 å¬å›è¡¨æ•°é‡ < 10

**æ‰§è¡Œå†…å®¹**:

- **æŒ‡æ ‡æœç´¢**ï¼šåœ¨ `ContextSearchTools` ä¸­æœç´¢ä¸šåŠ¡æŒ‡æ ‡
- **å‚è€ƒ SQL æœç´¢**ï¼šæŸ¥æ‰¾å†å²ç›¸ä¼¼æŸ¥è¯¢çš„ SQL æ¨¡å¼
- **çº¿ç¨‹å®‰å…¨æ›´æ–°**ï¼šä½¿ç”¨ `safe_context_update()` é˜²æ­¢ç«æ€æ¡ä»¶

#### **é˜¶æ®µ 3: Fallback å…¨è¡¨æ‰«æ**

**è§¦å‘æ¡ä»¶**ï¼šå‰ä¸¤é˜¶æ®µæœªæ‰¾åˆ°ä»»ä½•å€™é€‰è¡¨

**æ‰§è¡Œæµç¨‹**:

1. è°ƒç”¨ `_fallback_get_all_tables()` ä»æ•°æ®åº“è·å–å…¨éƒ¨è¡¨å
2. é™åˆ¶è¿”å›æ•°é‡ï¼ˆæœ€å¤š 50 å¼ è¡¨ï¼‰é¿å…ä¸Šä¸‹æ–‡æº¢å‡º
3. ä½¿ç”¨å€™é€‰è¡¨è¿›è¡Œåç»­å¤„ç†
4. **å¢å¼ºå›é€€ç­–ç•¥**ï¼šå½“ DDL æ£€ç´¢å¤±è´¥æ—¶ï¼Œå­˜å‚¨è¡¨åä¾› LLM å‚è€ƒ

### 3.4 Schema Validation (Schema å……åˆ†æ€§éªŒè¯)

**ç›®æ ‡**ï¼šåœ¨ SQL ç”Ÿæˆä¹‹å‰éªŒè¯å‘ç°çš„ Schema æ˜¯å¦å……åˆ†ã€‚

**éªŒè¯ç»´åº¦**:

1. **æœ€å°è¦æ±‚æ£€æŸ¥**ï¼šè‡³å°‘æœ‰ä¸€å¼ è¡¨è¢«æˆåŠŸå‘ç°
2. **å®Œæ•´æ€§æ£€æŸ¥**ï¼šæ‰€æœ‰å‘ç°çš„è¡¨éƒ½æœ‰å®Œæ•´çš„ DDL å®šä¹‰
3. **æŸ¥è¯¢-Schema å¯¹é½åº¦**ï¼šæ£€æŸ¥æŸ¥è¯¢å…³é”®è¯ä¸ Schema çš„è¦†ç›–åº¦

**åŠ¨æ€é˜ˆå€¼ç­–ç•¥**:

- **ç®€å•æŸ¥è¯¢** (â‰¤3 æœ¯è¯­): 50% è¦†ç›–åº¦è¦æ±‚
- **ä¸­ç­‰æŸ¥è¯¢** (4-6 æœ¯è¯­): 30% è¦†ç›–åº¦è¦æ±‚
- **å¤æ‚æŸ¥è¯¢** (>6 æœ¯è¯­): 20% è¦†ç›–åº¦è¦æ±‚

**ç¡¬å¤±è´¥æœºåˆ¶** â­ NEW v2.10ï¼š

- å½“ `table_schemas` ä¸ºç©ºï¼ˆæ— ä»»ä½• Schema å‘ç°ï¼‰æ—¶ï¼Œè§¦å‘ç¡¬å¤±è´¥
- ä½¿ç”¨ `ActionStatus.FAILED`ï¼ˆè€Œé SOFT_FAILEDï¼‰
- è®¾ç½® `allow_reflection=False`ï¼ˆä¸å…è®¸åæ€ï¼‰
- ç”Ÿæˆè¯¦ç»†è¯Šæ–­æŠ¥å‘Šï¼ŒåŒ…å«æ ¹å› åˆ†æå’Œä¿®å¤å‘½ä»¤
- ç›´æ¥ç»ˆæ­¢å·¥ä½œæµï¼Œé¿å…æ— æ•ˆçš„ SQL ç”Ÿæˆ

**è½¯å¤±è´¥æœºåˆ¶**ï¼š

- è¦†ç›–åº¦ä¸è¶³æ—¶ä½¿ç”¨ `ActionStatus.SOFT_FAILED`
- è®¾ç½® `allow_reflection=True` ç¡®ä¿ç»§ç»­åˆ° reflect èŠ‚ç‚¹è¿›è¡Œè‡ªæ„ˆ

### 3.5 Generate SQL (SQL ç”Ÿæˆ)

**ç›®æ ‡**ï¼šåŸºäºå·²éªŒè¯çš„ Schema ç”Ÿæˆå‡†ç¡®çš„ SQL æŸ¥è¯¢ã€‚

**å…³é”®ç‰¹æ€§**:

- å®Œå…¨ä¾èµ– `schema_discovery` åŠ è½½å¹¶é€šè¿‡ `schema_validation` éªŒè¯çš„ Schema
- ä½¿ç”¨ç»“æ„åŒ–æç¤ºè¯æ¨¡æ¿ï¼ˆ`sql_system_1.0.j2`ï¼‰
- æ”¯æŒå¤–éƒ¨çŸ¥è¯†ï¼ˆ`ext_knowledge`ï¼‰çš„ä¼˜å…ˆçº§æ³¨å…¥

### 3.6 SQL Validate (SQL éªŒè¯) â­ NEW v2.8

**ç›®æ ‡**ï¼šå¯¹ç”Ÿæˆçš„ SQL è¿›è¡Œé›†ä¸­å¼éªŒè¯ï¼Œåœ¨æ‰§è¡Œå‰å‘ç°é—®é¢˜ã€‚

**éªŒè¯ç»´åº¦**:

1. **SQL è¯­æ³•éªŒè¯**ï¼šé€šè¿‡ `sqlglot` è¿›è¡Œè¯­æ³•è§£æ
2. **SQL æ¨¡å¼éªŒè¯**ï¼š
   - æ— å¼•å·çš„ LIKE æ¨¡å¼
   - æ— å¼•å·çš„æ—¥æœŸå­—é¢é‡
   - éœ€è¦å¼•å·çš„ä¸­æ–‡æ–‡æœ¬
   - ç¼ºå¤±çš„é€—å·
3. **è¡¨/åˆ—å­˜åœ¨æ€§éªŒè¯**ï¼šé€šè¿‡ Schema metadata éªŒè¯è¡¨å’Œåˆ—æ˜¯å¦å­˜åœ¨
4. **å±é™©æ“ä½œæ£€æŸ¥**ï¼š
   - DELETE è¯­å¥ç¼ºå°‘ WHERE å­å¥
   - UPDATE è¯­å¥ç¼ºå°‘ WHERE å­å¥
   - DROP TABLE æ£€æµ‹
   - TRUNCATE æ£€æµ‹

**éªŒè¯å¤±è´¥å¤„ç†**:

- è®¾ç½® `termination_status = SKIP_TO_REFLECT`
- è·³è¿‡æ‰§è¡Œï¼Œç›´æ¥è¿›å…¥ reflect èŠ‚ç‚¹è¿›è¡Œä¿®å¤

**ä¸“ç”¨è¾“å…¥ç±»** (`SQLValidateInput`):

```python
class SQLValidateInput(BaseInput):
    sql_query: str  # å¾…éªŒè¯çš„ SQL
    dialect: Optional[str]  # æ•°æ®åº“æ–¹è¨€
    check_table_existence: bool = True  # æ£€æŸ¥è¡¨å­˜åœ¨æ€§
    check_column_existence: bool = True  # æ£€æŸ¥åˆ—å­˜åœ¨æ€§
    check_dangerous_operations: bool = True  # æ£€æŸ¥å±é™©æ“ä½œ
```

### 3.7 Execute SQL (SQL æ‰§è¡Œ)

**ç›®æ ‡**ï¼šåœ¨ç›®æ ‡æ•°æ®åº“ä¸­æ‰§è¡Œç”Ÿæˆçš„ SQL æŸ¥è¯¢ã€‚

**æ‰§è¡Œç‰¹æ€§**:

- æ”¯æŒå¤šç§æ•°æ®åº“ç±»å‹ï¼ˆSnowflake, SQLite, DuckDB, StarRocksï¼‰
- å¯é…ç½®çš„è¶…æ—¶æœºåˆ¶ï¼ˆé»˜è®¤ 60 ç§’ï¼‰
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

### 3.8 Result Validation (ç»“æœè´¨é‡éªŒè¯)

**ç›®æ ‡**ï¼šéªŒè¯ SQL æ‰§è¡Œç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

**éªŒè¯ç»´åº¦**:

1. **æ‰§è¡ŒçŠ¶æ€**ï¼šSQL æ˜¯å¦æˆåŠŸæ‰§è¡Œ
2. **ç»“æœç±»å‹**ï¼šåŒºåˆ† DDL/DML æŸ¥è¯¢ä¸ SELECT æŸ¥è¯¢
3. **ç»“æœè´¨é‡**ï¼šæ£€æŸ¥ç»“æœé›†çš„åˆç†æ€§

### 3.9 Reflect (åŠ¨æ€åæ€ä¸çº é”™)

**ç›®æ ‡**ï¼šèµ‹äºˆç³»ç»Ÿåœ¨æ‰§è¡Œå¤±è´¥åçš„è‡ªæˆ‘ä¿®å¤èƒ½åŠ›ã€‚

**ç­–ç•¥æ˜ å°„**:

- **SCHEMA_LINKING**ï¼šè¡¨ç¼ºå¤± â†’ æ’å…¥ SchemaLinkingNode â†’ SchemaValidationNode â†’ GenerateSQLNode
- **DOC_SEARCH**ï¼šæ–‡æ¡£æœç´¢ç¼ºå¤± â†’ æ’å…¥ DocSearchNode
- **SIMPLE_REGENERATE**ï¼šSQL é€»è¾‘é”™è¯¯ â†’ é‡æ–°æ‰§è¡Œ
- **REASONING**ï¼šéœ€è¦æ·±åº¦æ¢ç´¢ â†’ æ’å…¥ ReasoningNode

**å·¥ä½œæµç»ˆæ­¢æœºåˆ¶** â­ NEW v2.8:

- æ”¯æŒ `WorkflowTerminationStatus.TERMINATE_WITH_ERROR` ä¸»åŠ¨ç»ˆæ­¢
- æ”¯æŒ `WorkflowTerminationStatus.SKIP_TO_REFLECT` è·³è¿‡æ‰§è¡Œè¿›å…¥åæ€
- ç¡®ä¿ `workflow_task.cancel()` é˜²æ­¢åå°ç»§ç»­è¿è¡Œ

### 3.10 Output (ç»“æœè¾“å‡º)

**ç›®æ ‡**ï¼šå°†æœ€ç»ˆç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚

**è¾“å‡ºæ ¼å¼**:

- æ”¯æŒ CSVã€JSONã€Arrow ç­‰å¤šç§æ ¼å¼
- å¯é€‰çš„æ–‡ä»¶ä¿å­˜åŠŸèƒ½
- SSE æµå¼è¿”å›

**æ•°ä»“å¼€å‘ç‰ˆ SQL ç”ŸæˆæŠ¥å‘Š** â­ NEW v2.9

é’ˆå¯¹æ•°æ®ä»“åº“å¼€å‘è€…çš„äºŒæ¬¡å®¡æŸ¥éœ€æ±‚ï¼Œè¾“å‡ºèŠ‚ç‚¹ç”ŸæˆåŒ…å«ä»¥ä¸‹ 6 éƒ¨åˆ†çš„ç»¼åˆæŠ¥å‘Šï¼š

#### ç¬¬1éƒ¨åˆ†ï¼šSQL è®¾è®¡æ¦‚è¿°

- **ä»»åŠ¡ç†è§£**ï¼šå±•ç¤ºæ¾„æ¸…åçš„ä¸šåŠ¡éœ€æ±‚
- **è®¾è®¡æ€è·¯**ï¼šSQL è®¾è®¡çš„æ ¸å¿ƒé€»è¾‘ï¼ˆCTEã€JOINã€èšåˆç­‰ï¼‰
- **æ•°æ®è§„æ¨¡**ï¼šæ¶‰åŠçš„è¡¨æ•°é‡å’Œå­—æ®µæ•°é‡
- **éªŒè¯çŠ¶æ€**ï¼šè¯­æ³•ã€è¡¨å­˜åœ¨æ€§ã€åˆ—å­˜åœ¨æ€§éªŒè¯æ‘˜è¦

#### ç¬¬2éƒ¨åˆ†ï¼šä½¿ç”¨çš„è¡¨å’Œå­—æ®µè¯¦æƒ…

ä»¥è¡¨æ ¼å½¢å¼å±•ç¤ºä» DDL æå–çš„å…ƒæ•°æ®ï¼š

- **è¡¨æ¸…å•**ï¼šè¡¨åã€è¡¨å¤‡æ³¨ã€è¡¨ç±»å‹ã€æ•°æ®åº“ã€æ˜¯å¦ä½¿ç”¨
- **å­—æ®µæ¸…å•**ï¼šè¡¨åã€å­—æ®µåã€å­—æ®µæ³¨é‡Šã€ç”¨é€”ï¼ˆå…³è”é”®/ç­›é€‰æ¡ä»¶/è¾“å‡ºå­—æ®µï¼‰
- **è¡¨å…³è”å…³ç³»**ï¼šå±•ç¤º JOIN å…³ç³»å’Œå…³è”é”®

ç¤ºä¾‹æ ¼å¼ï¼š
```markdown
**è¡¨æ¸…å•** (1å¼ è¡¨):
| è¡¨å | è¡¨å¤‡æ³¨ | è¡¨ç±»å‹ | æ•°æ®åº“ | æ˜¯å¦ä½¿ç”¨ |
|------|--------|--------|--------|----------|
| dwd_assign_dlr_clue_fact_di | çº¿ç´¢äº‹å®è¡¨ | Fact Table | test | âœ… |

**å­—æ®µæ¸…å•** (5ä¸ªå­—æ®µ):
| è¡¨å | å­—æ®µå | å­—æ®µæ³¨é‡Š | ç”¨é€” |
|------|--------|----------|------|
| dwd_assign_dlr_clue_fact_di | customer_id | å®¢æˆ·ID | å…³è”é”® |
| dwd_assign_dlr_clue_fact_di | clue_type | çº¿ç´¢ç±»å‹ | ç­›é€‰æ¡ä»¶ |

**è¡¨å…³è”å…³ç³»**:
- table_a â† customer_id â†’ table_b (INNER JOIN)
```

#### ç¬¬3éƒ¨åˆ†ï¼šå¸¦æ³¨é‡Šçš„ SQL

ä¸º SQL æ·»åŠ ä¸šåŠ¡é€»è¾‘æ³¨é‡Šï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£è®¾è®¡æ„å›¾ï¼š

- **CTE æ³¨é‡Š**ï¼šæ¯ä¸ª CTE å‰æ·»åŠ è¯´æ˜ï¼ˆå¦‚ï¼š`-- CTE: first_events - è¯†åˆ«é¦–æ¬¡äº‹ä»¶`ï¼‰
- **å­—æ®µæ³¨é‡Š**ï¼šå…³é”®å­—æ®µæ·»åŠ ä¸šåŠ¡å«ä¹‰ï¼ˆå¦‚ï¼š`customer_id -- å®¢æˆ·ID`ï¼‰
- **æ¡ä»¶æ³¨é‡Š**ï¼šWHERE/JOIN æ¡ä»¶æ·»åŠ ä¸šåŠ¡è¯´æ˜

ç¤ºä¾‹ï¼š
```sql
-- SQLè®¾è®¡ç›®çš„: æŸ¥è¯¢é¦–æ¬¡è¯•é©¾åä¸‹å®šå®¢æˆ·
-- ä½¿ç”¨å…¬å…±è¡¨è¡¨è¾¾å¼(CTE)ç»„ç»‡å¤æ‚æŸ¥è¯¢é€»è¾‘
-- CTE: first_test_drive - è¯†åˆ«é¦–æ¬¡è¯•é©¾äº‹ä»¶
WITH first_test_drive AS (
    SELECT customer_id, -- å®¢æˆ·ID
           MIN(event_date) as first_drive_date
    FROM dwd_assign_dlr_clue_fact_di
    WHERE clue_type = 'é¦–æ¬¡è¯•é©¾' -- ç­›é€‰çº¿ç´¢ç±»å‹
    GROUP BY customer_id
)
...
```

#### ç¬¬4éƒ¨åˆ†ï¼šSQL éªŒè¯ç»“æœ

ä½¿ç”¨è¡¨æ ¼å½¢å¼æ¸…æ™°å±•ç¤ºéªŒè¯çŠ¶æ€ï¼š

```markdown
| éªŒè¯é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| è¯­æ³•éªŒè¯ | âœ… é€šè¿‡ | SQLè¯­æ³•æ­£ç¡®ï¼Œç¬¦åˆSQLæ–¹è¨€è§„èŒƒ |
| è¡¨å­˜åœ¨æ€§ | âœ… é€šè¿‡ | æ‰€æœ‰è¡¨éƒ½åœ¨Schemaä¸­å­˜åœ¨ |
| åˆ—å­˜åœ¨æ€§ | âœ… é€šè¿‡ | æ‰€æœ‰åˆ—éƒ½åœ¨å¯¹åº”è¡¨ä¸­å­˜åœ¨ |
| å±é™©æ“ä½œ | âœ… æ— å±é™©æ“ä½œ | æœªæ£€æµ‹åˆ°DELETE/DROP/TRUNCATEç­‰æ“ä½œ |
```

#### ç¬¬5éƒ¨åˆ†ï¼šæ‰§è¡ŒéªŒè¯ç»“æœ

**å…³é”®æ¾„æ¸…**ï¼šæ˜ç¡®åŒºåˆ† 0 è¡Œæ•°æ®ä¸ SQL é”™è¯¯

```markdown
**æ‰§è¡ŒçŠ¶æ€**: âœ… SQLå·²æˆåŠŸæ‰§è¡ŒéªŒè¯

**æ‰§è¡Œè¯¦æƒ…**:
- **è¯­æ³•æ­£ç¡®**: âœ… SQLè¯­æ³•éªŒè¯é€šè¿‡ï¼Œæ•°æ®åº“æˆåŠŸè§£æ
- **æ‰§è¡Œè¿”å›**: 0è¡Œæ•°æ®

**æ•°æ®æƒ…å†µè¯´æ˜**:
å½“å‰æ•°æ®åº“ä¸­æ²¡æœ‰åŒ¹é…æŸ¥è¯¢æ¡ä»¶çš„æ•°æ®ã€‚è¿™è¡¨æ˜:
- SQLé€»è¾‘æ­£ç¡®ï¼ˆæ— è¯­æ³•é”™è¯¯ï¼ŒæˆåŠŸæ‰§è¡Œï¼‰
- æ•°æ®åº“ä¸­æš‚æ— æ»¡è¶³æ¡ä»¶çš„æ•°æ®

**åç»­éªŒè¯å»ºè®®**:
å¦‚éœ€éªŒè¯SQLé€»è¾‘ï¼Œå¯ä»¥:
1. æ£€æŸ¥è¡¨æ•°æ®æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚ï¼šSELECT COUNT(*) FROM table_nameï¼‰
2. ç¡®è®¤ç­›é€‰æ¡ä»¶çš„æ—¶é—´èŒƒå›´æˆ–æšä¸¾å€¼æ˜¯å¦åˆç†
3. æ£€æŸ¥æ•°æ®æ˜¯å¦å·²åŠ è½½åˆ°æŒ‡å®šæ—¶é—´æ®µ

**SQLé€‚åˆç”Ÿäº§ä½¿ç”¨**: âœ… æ˜¯
```

#### ç¬¬6éƒ¨åˆ†ï¼šä¼˜åŒ–å»ºè®®

åŸºäº SQL ç»“æ„åˆ†ææä¾›å¯æ“ä½œçš„å»ºè®®ï¼š

- **æ€§èƒ½ä¼˜åŒ–**ï¼šCTE ä½¿ç”¨ã€ç´¢å¼•å»ºè®®ã€SELECT * è­¦å‘Š
- **æ•°æ®è´¨é‡å»ºè®®**ï¼šæ—¶é—´èŒƒå›´æ£€æŸ¥ã€æ•°æ®æšä¸¾å€¼éªŒè¯
- **åç»­åˆ†æå»ºè®®**ï¼šæ·»åŠ ç­›é€‰æ¡ä»¶ã€æ‰©å±•åˆ†æç»´åº¦

**æŠ€æœ¯å®ç°**ï¼š

- **14 ä¸ªè¾…åŠ©æ–¹æ³•**ï¼šåœ¨ `datus/api/event_converter.py` ä¸­å®ç°
- **DDL è§£æ**ï¼šå¤ç”¨ `parse_metadata_from_ddl()` å·¥å…·
- **SQL ç»“æ„åˆ†æ**ï¼šä½¿ç”¨ `sqlglot` åº“è§£æ SQL
- **æ•°æ®æµ**ï¼š`OutputNode` â†’ `workflow.metadata["table_schemas"]` â†’ `EventConverter`

**è¾…åŠ©æ–¹æ³•åˆ—è¡¨**ï¼ˆå…± 14 ä¸ªï¼‰ï¼š

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `_parse_ddl_comments()` | ä» DDL æå–è¡¨å’Œåˆ—æ³¨é‡Š |
| `_extract_table_info()` | æå–è¡¨å’Œå­—æ®µä¿¡æ¯ |
| `_analyze_relationships()` | åˆ†æè¡¨å…³è”å…³ç³» |
| `_infer_field_usage()` | æ¨æ–­å­—æ®µç”¨é€”ï¼ˆå…³è”é”®/ç­›é€‰/è¾“å‡ºï¼‰ |
| `_parse_sql_structure()` | ä½¿ç”¨ sqlglot è§£æ SQL ç»“æ„ |
| `_infer_cte_purpose()` | æ¨æ–­ CTE çš„ä¸šåŠ¡ç›®çš„ |
| `_get_field_comment()` | ä» Schema è·å–å­—æ®µæ³¨é‡Š |
| `_add_field_comment()` | ä¸ºå­—æ®µæ·»åŠ å†…è”æ³¨é‡Š |
| `_explain_condition()` | è§£é‡Šæ¡ä»¶çš„ä¸šåŠ¡å«ä¹‰ |
| `_add_condition_comments()` | ä¸º WHERE/JOIN æ¡ä»¶æ·»åŠ æ³¨é‡Š |
| `_generate_sql_with_comments()` | ç”Ÿæˆå¸¦æ³¨é‡Šçš„ SQL |
| `_generate_execution_report()` | ç”Ÿæˆæ‰§è¡ŒéªŒè¯æŠ¥å‘Š |
| `_generate_optimization_suggestions()` | ç”Ÿæˆä¼˜åŒ–å»ºè®® |
| `_escape_markdown_table_cell()` | è½¬ä¹‰ Markdown è¡¨æ ¼ç‰¹æ®Šå­—ç¬¦ |

## 4. æ‰§è¡Œæµç¨‹å®ä¾‹ (å®Œæ•´è‡ªæ„ˆè¿‡ç¨‹)

```mermaid
graph TD
    A[Start] --> B[Intent Analysis]
    B --> C[Intent Clarification]
    C --> D[Schema Discovery Stage 1]
    D --> E{< 10 tables?}
    E -- Yes --> F[Context Search Stage 2]
    E -- No --> G[Schema Validation]
    F --> G
    G --> H{Schema Sufficient?}
    H -- Yes --> I[Generate SQL]
    H -- No --> J[Reflect SOFT_FAILED]
    I --> K[SQL Validate]
    K --> L{SQL Valid?}
    L -- Yes --> M[Execute SQL]
    L -- No --> J
    M --> N[Result Validation]
    N --> O{Result Valid?}
    O -- Yes --> P[Output]
    O -- No --> J
    J --> Q{Recoverable?}
    Q -- Yes --> R[Inject Recovery Node]
    R --> G
    Q -- No --> S[Terminate]
```

## 5. æ€§èƒ½ä¸ç›‘æ§

### 5.1 å¤šå±‚ç¼“å­˜æ¶æ„

**L1 ç¼“å­˜** (`datus/storage/cache.py`):

- **å¯¹è±¡**ï¼šåµŒå…¥æ¨¡å‹å®ä¾‹
- **å®¹é‡**ï¼š`@lru_cache(maxsize=12)`

**LLM ç¼“å­˜**:

- **å¯¹è±¡**ï¼šLLM è¡¨å‘ç°ç»“æœã€æ„å›¾æ¾„æ¸…ç»“æœ
- **TTL**ï¼š1 å°æ—¶ï¼ˆ3600 ç§’ï¼‰

**CLI ç¼“å­˜** (`datus/cli/screen/subject_screen.py`):

- **å¯¹è±¡**ï¼šæŒ‡æ ‡å’Œ SQL è¯¦æƒ…
- **å®¹é‡**ï¼š`@lru_cache(maxsize=128)`

### 5.2 å‘é‡æœç´¢ä¼˜åŒ–

- **Top N**ï¼š20ï¼ˆå¢åŠ å¬å›èŒƒå›´ï¼‰
- **ç›¸ä¼¼åº¦é˜ˆå€¼**ï¼š0.5ï¼ˆè¿‡æ»¤å¼±åŒ¹é…ï¼‰
- **è·ç¦»è½¬æ¢**ï¼š`similarity = 1.0 / (1.0 + distance)`

### 5.3 å®æ—¶åé¦ˆä¸æ—¥å¿—

- **SSE æµå¼æ¨é€**ï¼šå®æ—¶è¿”å› `ToolCallEvent` å’Œæ‰§è¡ŒçŠ¶æ€
- **ç»“æ„åŒ–æ—¥å¿—**ï¼šè®°å½•æ¯ä¸ªé˜¶æ®µçš„å†³ç­–å’ŒéªŒè¯ç»“æœ

## 6. æŠ€æœ¯å®ç°ç»†èŠ‚

### 6.1 EventConverter æ–°å¢æ–¹æ³• â­ NEW v2.9

**æ•°ä»“å¼€å‘ç‰ˆ SQL æŠ¥å‘Š**ç›¸å…³æ–¹æ³•ï¼ˆ`datus/api/event_converter.py`ï¼‰ï¼š

**DDL è§£ææ–¹æ³•**ï¼š
- `_parse_ddl_comments()` - ä» DDL æå–è¡¨å’Œåˆ—æ³¨é‡Š
- `_extract_table_info()` - æå–è¡¨å’Œå­—æ®µä¿¡æ¯ï¼Œä» SQL è¯†åˆ«ä½¿ç”¨çš„åˆ—

**SQL ç»“æ„è§£ææ–¹æ³•**ï¼š
- `_parse_sql_structure()` - ä½¿ç”¨ sqlglot è§£æ SQL ç»“æ„
- `_analyze_relationships()` - åˆ†æè¡¨å…³è”å…³ç³»ï¼ˆJOIN é”®ï¼‰
- `_infer_field_usage()` - æ¨æ–­å­—æ®µç”¨é€”ï¼ˆå…³è”é”®/ç­›é€‰æ¡ä»¶/è¾“å‡ºå­—æ®µï¼‰

**SQL æ³¨é‡Šç”Ÿæˆæ–¹æ³•**ï¼š
- `_generate_sql_with_comments()` - ç”Ÿæˆå¸¦æ³¨é‡Šçš„ SQL
- `_infer_cte_purpose()` - æ¨æ–­ CTE çš„ä¸šåŠ¡ç›®çš„
- `_add_field_comment()` - ä¸ºå­—æ®µæ·»åŠ å†…è”æ³¨é‡Š
- `_add_condition_comments()` - ä¸º WHERE/JOIN æ¡ä»¶æ·»åŠ æ³¨é‡Š
- `_explain_condition()` - è§£é‡Šæ¡ä»¶çš„ä¸šåŠ¡å«ä¹‰
- `_get_field_comment()` - ä» Schema è·å–å­—æ®µæ³¨é‡Š

**æŠ¥å‘Šç”Ÿæˆæ–¹æ³•**ï¼š
- `_generate_execution_report()` - ç”Ÿæˆæ‰§è¡ŒéªŒè¯æŠ¥å‘Šï¼ˆåŒºåˆ† 0 è¡Œä¸é”™è¯¯ï¼‰
- `_generate_optimization_suggestions()` - ç”Ÿæˆæ€§èƒ½ä¼˜åŒ–å»ºè®®

### 6.2 OutputNode æ•°æ®æµå¢å¼º â­ NEW v2.9

**ä¼ é€’ table_schemas åˆ° metadata**ï¼ˆ`datus/agent/node/output_node.py`ï¼‰ï¼š

```python
workflow_metadata = {
    "sql_validation": workflow.metadata.get("sql_validation"),
    "intent_clarification": workflow.metadata.get("intent_clarification"),
    "clarified_task": workflow.metadata.get("clarified_task"),
    "intent_analysis": workflow.metadata.get("intent_analysis"),
    "reflection_count": workflow.metadata.get("reflection_count", 0),
    "table_schemas": workflow.context.table_schemas,  # â­ NEW
}
```

**EventConverter æ¥æ”¶å¹¶ä½¿ç”¨**ï¼ˆ`datus/api/event_converter.py`ï¼‰ï¼š

```python
table_schemas = metadata.get("table_schemas")
report = self._generate_sql_generation_report(
    sql_query=final_sql,
    sql_result=final_result,
    row_count=row_count,
    metadata=metadata,
    table_schemas=table_schemas  # â­ NEW
)
```

### 6.3 SchemaStorage æ–°å¢æ–¹æ³•

**get_table_schemas()** - æ‰¹é‡è·å–å¤šä¸ªè¡¨çš„ç»“æ„å®šä¹‰

**update_table_schema()** - æ›´æ–°æˆ–æ’å…¥è¡¨çš„ Schema å®šä¹‰ï¼Œç”¨äºå…ƒæ•°æ®ä¿®å¤

### 6.4 çº¿ç¨‹å®‰å…¨ä¸Šä¸‹æ–‡æ›´æ–°

**safe_context_update()** - é˜²æ­¢å¹¶å‘è®¿é—®å¯¼è‡´çš„ç«æ€æ¡ä»¶

### 6.5 ä¾èµ–åº“æ–°å¢ â­ NEW v2.9

**sqlglot** - SQL è§£æå’Œç»“æ„åˆ†æåº“

- ç”¨äºè§£æ SQL ç»“æ„ï¼ˆCTEã€JOINã€WHEREã€GROUP BY ç­‰ï¼‰
- è¯†åˆ«è¡¨å’Œåˆ—å¼•ç”¨
- åˆ†æ SQL æ¨¡å¼ï¼ˆèšåˆã€çª—å£å‡½æ•°ã€å­æŸ¥è¯¢ç­‰ï¼‰

å®‰è£…ï¼š
```bash
pip install sqlglot
```

## 7. æ€»ç»“

### v2.10 æ ¸å¿ƒæ”¹è¿›ï¼ˆ2026-01-23ï¼‰

1. âœ… **Preflight Orchestrator**ï¼šé¢„æ£€å·¥å…·ç¼–æ’å™¨ï¼Œåè°ƒ4ä¸ªå¿…éœ€å·¥å…·æ‰§è¡Œ
2. âœ… **ç¡¬å¤±è´¥æœºåˆ¶**ï¼šæ—  Schema æ—¶ç›´æ¥ç»ˆæ­¢ï¼Œä¸è¿›å…¥åæ€ç¯èŠ‚
3. âœ… **å¤šæ•°æ®åº“æ”¯æŒ**ï¼šSchema å‘ç°æ”¯æŒæ‰«æå¤šä¸ªæ•°æ®åº“
4. âœ… **LLM Schema åŒ¹é…**ï¼šå¤§è§„æ¨¡æ•°æ®é›†ä½¿ç”¨ LLM è¿›è¡Œè¡¨åŒ¹é…
5. âœ… **æ¸è¿›å¼åŒ¹é…**ï¼šæ ¹æ®åæ€è½®æ¬¡åŠ¨æ€è°ƒæ•´åŒ¹é…ç­–ç•¥

### v2.9 æ ¸å¿ƒæ”¹è¿›ï¼ˆ2026-01-17ï¼‰

1. âœ… **æ•°ä»“å¼€å‘ç‰ˆ SQL æŠ¥å‘Š**ï¼šé¢å‘æ•°æ®ä»“åº“å¼€å‘è€…çš„ 6 éƒ¨åˆ†ç»¼åˆæŠ¥å‘Š
2. âœ… **å¸¦æ³¨é‡Šçš„ SQL**ï¼šè‡ªåŠ¨æ·»åŠ  CTE è¯´æ˜ã€å­—æ®µæ³¨é‡Šã€æ¡ä»¶è§£é‡Š
3. âœ… **è¡¨å’Œå­—æ®µè¯¦æƒ…**ï¼šä» DDL æå–è¡¨/å­—æ®µæ³¨é‡Šï¼Œå±•ç¤ºå…³è”å…³ç³»å’Œå­—æ®µç”¨é€”
4. âœ… **æ‰§è¡ŒéªŒè¯æŠ¥å‘Š**ï¼šæ˜ç¡®åŒºåˆ† 0 è¡Œæ•°æ®ä¸ SQL é”™è¯¯
5. âœ… **ä¼˜åŒ–å»ºè®®ç”Ÿæˆ**ï¼šåŸºäº SQL ç»“æ„åˆ†ææä¾›æ€§èƒ½ä¼˜åŒ–å»ºè®®
6. âœ… **14 ä¸ªè¾…åŠ©æ–¹æ³•**ï¼šDDL è§£æã€SQL ç»“æ„åˆ†æã€å­—æ®µç”¨é€”æ¨æ–­ç­‰
7. âœ… **sqlglot é›†æˆ**ï¼šä½¿ç”¨ sqlglot åº“è¿›è¡Œ SQL ç»“æ„è§£æ

### v2.8 æ ¸å¿ƒæ”¹è¿›ï¼ˆ2026-01-16ï¼‰

1. âœ… **æ„å›¾æ¾„æ¸…èŠ‚ç‚¹**ï¼šä¿®å¤é”™åˆ«å­—ã€æ¾„æ¸…æ­§ä¹‰ã€æå–å®ä½“
2. âœ… **ä¸“ç”¨ SQL éªŒè¯èŠ‚ç‚¹**ï¼šé›†ä¸­å¼ SQL è¯­æ³•å’Œè¯­ä¹‰éªŒè¯
3. âœ… **å·¥ä½œæµç»ˆæ­¢æœºåˆ¶**ï¼šæ”¯æŒä¸»åŠ¨ç»ˆæ­¢å’Œè·³è½¬
4. âœ… **ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤**ï¼šè¯­ä¹‰æœç´¢å¢åŠ  0.5 ç›¸ä¼¼åº¦é˜ˆå€¼
5. âœ… **Context Search ä¼˜åŒ–**ï¼šè§¦å‘é˜ˆå€¼ä» 3 æå‡åˆ° 10
6. âœ… **æ‰¹é‡ Schema æŸ¥è¯¢**ï¼šæ–°å¢ `get_table_schemas()` æ–¹æ³•
7. âœ… **å…ƒæ•°æ®è‡ªåŠ¨ä¿®å¤**ï¼š`update_table_schema()` æ–¹æ³•æ”¯æŒ DDL å›å¡«
8. âœ… **å¤šå±‚ç¼“å­˜æœºåˆ¶**ï¼šL1ã€LLMã€CLI ä¸‰å±‚ç¼“å­˜

### å®Œæ•´çš„ä»·å€¼ä½“ç°

- ğŸ¯ **æé«˜ç²¾åº¦**ï¼šæ„å›¾æ¾„æ¸… + ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤
- ğŸ”„ **å¢å¼ºå¬å›**ï¼šContext Search æ›´é¢‘ç¹è§¦å‘ + Fallback å…¨è¡¨æ‰«æ
- ğŸ›¡ï¸ **åŒé‡éªŒè¯**ï¼šSchema å……åˆ†æ€§ + SQL è¯­æ³•è¯­ä¹‰
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡æŸ¥è¯¢ + å¤šå±‚ç¼“å­˜
- ğŸ”’ **çº¿ç¨‹å®‰å…¨**ï¼š`safe_context_update()` é˜²æ­¢å¹¶å‘é—®é¢˜
- ğŸ›‘ **ä¸»åŠ¨ç»ˆæ­¢**ï¼šå·¥ä½œæµç»ˆæ­¢æœºåˆ¶ + ç¡¬å¤±è´¥é¿å…æ— æ•ˆæ‰§è¡Œ
- ğŸ“Š **å¼€å‘è€…å‹å¥½**ï¼š6 éƒ¨åˆ† SQL æŠ¥å‘Š + å¸¦æ³¨é‡Šçš„ SQL + å…ƒæ•°æ®å±•ç¤º
- ğŸ›ï¸ **é¢„æ£€ç¼–æ’**ï¼šPreflight Orchestrator ç¡®ä¿è¯æ®å……åˆ†

## 8. SQL å®¡æŸ¥ä»»åŠ¡è¯´æ˜

### 8.1 ä»»åŠ¡è¯†åˆ«ä¸åˆ†ç±»

`IntentAnalysisNode` è´Ÿè´£è¯†åˆ«ä»»åŠ¡ç±»å‹ã€‚å½“æ£€æµ‹åˆ° SQL å®¡æŸ¥å…³é”®è¯æ—¶ï¼ˆå¦‚"å®¡æŸ¥"ã€"review"ã€"æ£€æŸ¥"ã€"audit"ç­‰ï¼‰ï¼Œä¼šå°†ä»»åŠ¡ç±»å‹è¯†åˆ«ä¸º `sql_review`ã€‚

### 8.2 SQL å®¡æŸ¥å·¥ä½œæµ

SQL å®¡æŸ¥ä»»åŠ¡ä½¿ç”¨ä¸“ç”¨çš„ `chat_agentic_plan` å·¥ä½œæµï¼Œè€Œé `text2sql` å·¥ä½œæµï¼š

```yaml
# SQLå®¡æŸ¥ä¸“ç”¨å·¥ä½œæµ
chat_agentic_plan:
  - chat_agentic  # å¯¹è¯å¼ AI äº¤äº’ï¼Œæ”¯æŒå·¥å…·è°ƒç”¨
  - output        # ç»“æœè¾“å‡º
```

**å…³é”®é…ç½®**ï¼ˆ`datus/api/service.py`ï¼‰:

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| å·¥ä½œæµ | `chat_agentic_plan` |
| plan_mode | `False` |
| system_prompt | `sql_review` |
| output_format | `markdown` |
| é¢„æ£€å·¥å…· | 7 ä¸ªå¼ºåˆ¶å·¥å…·åºåˆ— |

### 8.3 å¼ºåˆ¶é¢„æ£€å·¥å…·åºåˆ—

SQL å®¡æŸ¥ä»»åŠ¡åœ¨ LLM æ¨ç†å‰å¼ºåˆ¶æ‰§è¡Œ 7 ä¸ªé¢„æ£€å·¥å…·ï¼š

| åºå· | å·¥å…·åç§° | åŠŸèƒ½ |
|------|----------|------|
| 1 | `describe_table` | è·å–è¡¨ç»“æ„ä¿¡æ¯ |
| 2 | `search_external_knowledge` | æ£€ç´¢ StarRocks è§„åˆ™ |
| 3 | `read_query` | SQL è¯­æ³•éªŒè¯ |
| 4 | `get_table_ddl` | DDL å®šä¹‰è·å– |
| 5 | `analyze_query_plan` | æŸ¥è¯¢è®¡åˆ’åˆ†æ |
| 6 | `check_table_conflicts` | è¡¨å†²çªæ£€æµ‹ |
| 7 | `validate_partitioning` | åˆ†åŒºéªŒè¯ |

### 8.4 Text2SQL vs SQL å®¡æŸ¥å¯¹æ¯”

| ç‰¹æ€§ | Text2SQL | SQL å®¡æŸ¥ |
|------|----------|----------|
| å·¥ä½œæµ | `text2sql` (10 æ­¥) | `chat_agentic_plan` |
| æ‰§è¡Œæ¨¡å¼ | Preflight Orchestrator | å¼ºåˆ¶å·¥å…·åºåˆ— |
| è¾“å‡ºæ ¼å¼ | JSON æ•°æ® | Markdown æŠ¥å‘Š |
| åæ€æœºåˆ¶ | Reflect èŠ‚ç‚¹ | æ—  |
| éªŒè¯èŠ‚ç‚¹ | sql_validate, result_validation | æ—  |

### 8.5 è¯¦ç»†æ–‡æ¡£

SQL å®¡æŸ¥ä»»åŠ¡çš„å®Œæ•´å¤„ç†æµç¨‹ã€å·¥å…·è¯¦è§£å’Œé…ç½®ç¤ºä¾‹ï¼Œè¯·å‚é˜…ï¼š

- **[SQL å®¡æŸ¥ä»»åŠ¡å¤„ç†æµç¨‹ä»‹ç»](Datus%20SQL%20Review%20ä»»åŠ¡å¤„ç†æµç¨‹ä»‹ç».md)**
- åŒ…å« 7 ä¸ªé¢„æ£€å·¥å…·çš„å®Œæ•´å®ç°
- åŒ…å« SQL å®¡æŸ¥æç¤ºè¯æ¨¡æ¿
- åŒ…å«é”™è¯¯å¤„ç†å’Œäº‹ä»¶æµæœºåˆ¶
