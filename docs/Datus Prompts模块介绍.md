# Datus Prompts 模块介绍

> **文档版本**: v1.0
> **更新日期**: 2026-01-05
> **相关模块**: `datus/prompts/`

---

## 模块概述

### 🏗️ 整体设计架构理念

**"版本化提示工程架构"** - 通过Jinja2模板 + 文件版本管理实现结构化的LLM提示管理

Datus Prompts模块采用了**模板驱动的提示工程架构**，核心设计理念是：

1. **版本化管理**：每个提示模板都有独立的版本控制
2. **模板化渲染**：使用Jinja2实现动态提示生成
3. **分层抽象**：将提示逻辑与业务逻辑分离
4. **可扩展定制**：支持用户自定义提示模板

### 📊 架构层次结构

```
┌─────────────────────────────────────────┐
│            应用层 (Agent/Node)            │
├─────────────────────────────────────────┤
│        提示组装层 (Prompt Functions)       │
├─────────────────────────────────────────┤
│        模板管理层 (PromptManager)          │
├─────────────────────────────────────────┤
│        模板存储层 (Jinja2 Templates)        │
└─────────────────────────────────────────┘
```

### 🎯 核心设计特性

#### 1. **版本化提示管理**
```python
# 文件命名规范：{template_name}_{version}.j2
gen_sql_system_1.0.j2
gen_sql_user_1.0.j2
reasoning_system_1.0.j2
```

**设计优势**：
- **渐进式改进**：新版本可以安全部署，不会影响现有功能
- **回滚支持**：可以快速回退到之前的提示版本
- **A/B测试**：可以同时运行多个版本进行对比测试

#### 2. **双层搜索路径**
```python
# 优先用户自定义目录，然后回退到内置模板
search_paths = [str(self.user_templates_dir), str(self.default_templates_dir)]
```

**设计优势**：
- **用户定制化**：用户可以覆盖内置提示模板
- **向后兼容**：始终有内置模板作为fallback
- **渐进升级**：用户可以逐步定制需要的提示

#### 3. **Jinja2动态渲染**
```python
# 模板变量动态注入
user_content = prompt_manager.render_template(
    "gen_sql_user",
    database_type=database_type,
    question=question,
    processed_schemas=processed_schemas,
    **kwargs
)
```

**设计优势**：
- **类型安全**：变量在渲染时进行类型检查
- **逻辑复用**：相同的模板可以用于不同场景
- **可维护性**：模板逻辑与Python代码分离

#### 4. **结构化提示组装**
```python
def get_sql_prompt(...) -> List[Dict[str, str]]:
    system_content = prompt_manager.get_raw_template("gen_sql_system", version)
    user_content = prompt_manager.render_template("gen_sql_user", **variables)
    
    return [
        {"role": "system", "content": system_content},
        {"role": "user", "content": user_content},
    ]
```

**设计优势**：
- **标准化接口**：统一的提示格式（system + user messages）
- **模块化组合**：系统提示和用户提示分离管理
- **参数验证**：在组装时进行输入验证和截断处理

### 🔄 提示工程设计模式

#### **1. SQL生成提示模式**
```
系统提示：定义角色、能力、输出格式
用户提示：注入具体上下文（schema、问题、约束）
```

#### **2. 推理链提示模式**
```
单一用户提示：包含所有上下文信息
依赖LLM的工具调用能力进行迭代推理
```

#### **3. 修复优化提示模式**
```
错误上下文 + 修复指令
基于执行结果进行目标导向的修复
```

### 🎨 设计哲学总结

Datus Prompts模块的设计哲学可以总结为：

**"通过版本化模板管理和结构化提示组装，实现可维护、可扩展的LLM提示工程"**

1. **版本化保障可靠性**：提示模板的版本控制确保了系统行为的稳定性和可预测性
2. **模板化提升复用性**：Jinja2模板系统实现了提示逻辑的复用和参数化
3. **分层设计简化复杂度**：将提示管理、组装、渲染分离到不同层次
4. **用户中心的设计理念**：支持用户定制的同时保持系统的向后兼容性

这种设计使得Datus不仅是一个数据工程工具，更是一个**成熟的AI提示工程平台**，能够为复杂的数据工作流提供高质量、结构化的LLM交互能力。提示系统的模块化设计确保了每个组件都可以独立演进，同时保持整体架构的一致性和可扩展性。